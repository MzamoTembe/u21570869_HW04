@using u21570869_HW04.Models;
@{
    ViewBag.Title = "Chat";
}
<h2>Chat</h2>

@*Chat Section*@
<div class="container">
    <h3 class=" text-center">Messaging</h3>
    <div class="messaging">
        <div class="inbox_msg">

            @*Inbox Side*@
            <div class="inbox_people">
                @*Header for Inbox side*@
                <div class="headind_srch">
                    <div class="recent_heading">
                        <h4>Users</h4>
                        <input style="margin-right: 10px; max-width: 100px" class="btn btn-danger col-sm-4" id="blocker" type="submit" value="BlockStudent" onclick="location.href='@Url.Action("Block", "Home", new { username = Model.Name })'">
                        <input style="margin-right: 10px; max-width: 100px" class="btn btn-primary col-sm-4" id="refresh" type="button" value="Refresh">
                    </div>
                </div>
                @*Users Present*@
                <div class="inbox_chat" id="users">
                    @{
                        <script>
                            $('#inbox_chat').empty();
                        </script>
                        foreach (var pusers in Repository.Users)
                        {
                            <div class="chat_list" id="@pusers.Name">
                                <div class="chat_people">
                                    @if (pusers.Gender == "female")
                                    {
                                        <div class="chat_img"> <img src="https://cdn-icons-png.flaticon.com/512/194/194936.png"> </div>
                                    }
                                    else
                                    {
                                        <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png"> </div>
                                    }

                                    <div class="chat_ib">
                                        <h5>@pusers.Name </h5>
                                        <p>
                                            @pusers.Description
                                        </p>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
            @*Messages*@
            <div class="mesgs">
                <div class="msg_history" id="messagestest">
                </div>
                <div class="row">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Type a message" id="message" style="max-width: 100%;">
                        <span class="input-group-btn">
                            <button class="btn btn-default form-control" type="button" id="sendmessage">Send</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@*Inputs for socket*@
<input type="hidden" id="displayname" value="@Model.Name" />
<input type="hidden" id="usertype" value="@Model.Type" />
<input type="hidden" id="description" value="@Model.Description" />
<input type="hidden" id="status" value="@Model.Status" />
<input type="hidden" id="gender" value="@Model.Gender" />
<input type="hidden" id="isblocked" value="@Repository.Users.Find(x => x.Name == Model.Name).IsBlocked.ToString()" />

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>

        // Function to refresh for the Blocked Users to show on client side
        $("#refresh").click(function () {
            location.reload();
        });

        $(function () {
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message, type, description, status, gender) {
                // Add the message to the page.
                if (htmlEncode(type) == "teacher") {

                    if (htmlEncode(gender) == "female") {
                        $('#messagestest').append(
                            '<div class="incoming_msg"><div class="incoming_msg_img">' +
                            '<img src = "https://cdn-icons-png.flaticon.com/512/194/194936.png">' +
                            '</div > <div class="received_msg"><div class="received_withd_msg">' + htmlEncode(name) + '<p>' +
                            htmlEncode(message) +
                            '</p></div></div></div></div>'
                        );
                    }
                    else {
                        $('#messagestest').append(
                            '<div class="incoming_msg"><div class="incoming_msg_img">' +
                            '<img src = "https://ptetutorials.com/images/user-profile.png">' +
                            '</div > <div class="received_msg"><div class="received_withd_msg">' + htmlEncode(name) + '<p>' +
                            htmlEncode(message) +
                            '</p></div></div></div></div>'
                        );
                    }
                }
                if (htmlEncode(type) == "student") {
                    if (htmlEncode(status) == "False") {
                        $('#messagestest').append(
                            '<div class="outgoing_msg"><div class="sent_msg">' + htmlEncode(name) + '<p>' +
                            htmlEncode(message) + '</p></div></div>'
                        );
                    }
                    if (htmlEncode(status) == "True") {
                        $('#messagestest').append(
                            '<div class="alert alert-danger" role="alert">' +
                            htmlEncode(name) + ", you are is BLOCKED!" +
                            '</div>'
                        );
                    }
                }
            };
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send($('#displayname').val(), $('#message').val(), $('#usertype').val(), $('#description').val(), $('#isblocked').val(), $('#gender').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}

<style>
    .container {
        max-width: 1170px;
        margin: auto;
    }

    img {
        max-width: 100%;
    }

    .inbox_people {
        background: #f8f8f8 none repeat scroll 0 0;
        float: left;
        overflow: hidden;
        width: 40%;
        border-right: 1px solid #c4c4c4;
    }

    .inbox_msg {
        border: 1px solid #c4c4c4;
        clear: both;
        overflow: hidden;
    }

    .top_spac {
        margin: 20px 0 0;
    }


    .recent_heading {
        float: left;
        width: 100%;
    }



    .headind_srch {
        padding: 10px 29px 10px 20px;
        overflow: hidden;
        border-bottom: 1px solid #c4c4c4;
    }

    .recent_heading h4 {
        color: #05728f;
        font-size: 21px;
        margin: auto;
    }


    .chat_ib h5 {
        font-size: 15px;
        color: #464646;
        margin: 0 0 8px 0;
    }

        .chat_ib h5 span {
            font-size: 13px;
            float: right;
        }

    .chat_ib p {
        font-size: 14px;
        color: #989898;
        margin: auto
    }

    .chat_img {
        float: left;
        width: 11%;
    }

    .chat_ib {
        float: left;
        padding: 0 0 0 15px;
        width: 88%;
    }

    .chat_people {
        overflow: hidden;
        clear: both;
    }

    .chat_list {
        border-bottom: 1px solid #c4c4c4;
        margin: 0;
        padding: 18px 16px 10px;
    }

    .inbox_chat {
        height: 550px;
        overflow-y: scroll;
    }

    .active_chat {
        background: #ebebeb;
    }

    .incoming_msg_img {
        display: inline-block;
        width: 6%;
    }

    .received_msg {
        display: inline-block;
        padding: 0 0 0 10px;
        vertical-align: top;
        width: 92%;
    }

    .received_withd_msg p {
        background: #ebebeb none repeat scroll 0 0;
        border-radius: 3px;
        color: #646464;
        font-size: 14px;
        margin: 0;
        padding: 5px 10px 5px 12px;
        width: 100%;
    }


    .received_withd_msg {
        width: 57%;
    }

    .mesgs {
        float: left;
        padding: 30px 15px 0 25px;
        width: 60%;
    }

    .sent_msg p {
        background: #05728f none repeat scroll 0 0;
        border-radius: 3px;
        font-size: 14px;
        margin: 0;
        color: #fff;
        padding: 5px 10px 5px 12px;
        width: 100%;
    }

    .outgoing_msg {
        overflow: hidden;
        margin: 26px 0 26px;
    }

    .sent_msg {
        float: right;
        width: 46%;
    }

    .messaging {
        padding: 0 0 50px 0;
    }

    .msg_history {
        height: 516px;
        overflow-y: auto;
    }
</style>
